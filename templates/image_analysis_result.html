{% extends "base.html" %}

{% block title %}نتائج تحليل الصورة - {{ analysis.filename }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto" id="report-content">
    <!-- شريط العنوان -->
    <div class="gradient-bg rounded-xl p-6 text-white shadow-lg mb-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">تقرير فحص ملف الصورة</h1>
                <p class="opacity-90 mt-1">نتيجة التحليل الأمني للملف باستخدام محركات متعددة</p>
            </div>
            <div class="mt-4 md:mt-0 text-center">
                <div class="text-sm opacity-80">تاريخ الفحص</div>
                <div class="text-lg font-semibold">
                    {% if analysis.created_at %}
                        {{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        {{ now.strftime('%Y-%m-%d %H:%M') }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- معلومات الفحص -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h2 class="text-xl font-bold text-green-600 mb-2">معلومات الملف</h2>
                <div class="flex items-center">
                    <span class="bg-gray-200 rounded-full p-2 mr-3">
                        <i class="fas fa-file-image text-gray-700"></i>
                    </span>
                    <div>
                        <h3 class="font-semibold text-lg">{{ analysis.filename }}</h3>
                        <p class="text-gray-600 text-sm">الحجم: {{ analysis.file_size // 1024 }} ك.ب | الهاش: {{ analysis.file_hash[:8] }}...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 md:mt-0">
                <span class="px-4 py-2 rounded-full text-lg font-bold
                    {% if analysis.is_malicious %} bg-red-100 text-red-800
                    {% else %} bg-green-100 text-green-800 {% endif %}">
                    {% if analysis.is_malicious %}ملف ضار{% else %}ملف آمن{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- ملخص النتائج -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-200">ملخص النتائج</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 border-blue-500">
                <div class="flex items-center mb-3">
                    <i class="fas fa-font text-blue-400 text-xl mr-2"></i>
                    <h3 class="font-semibold text-white">التهديدات النصية</h3>
                </div>
                <p class="text-3xl font-bold text-blue-400">{{ results.text_analysis.unique_threats if results and results.text_analysis else 0 }}</p>
            </div>

            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 border-red-500">
                <div class="flex items-center mb-3">
                    <i class="fas fa-eye-slash text-red-400 text-xl mr-2"></i>
                    <h3 class="font-semibold text-white">النصوص المخفية</h3>
                </div>
                <p class="text-3xl font-bold text-red-400">{{ results.hidden_text_analysis.unique_threats if results and results.hidden_text_analysis else 0 }}</p>
            </div>

            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 border-yellow-500">
                <div class="flex items-center mb-3">
                    <i class="fas fa-database text-yellow-400 text-xl mr-2"></i>
                    <h3 class="font-semibold text-white">بيانات مخفية</h3>
                </div>
                <p class="text-3xl font-bold text-yellow-400">
                    {% if results and results.hidden_data and (results.hidden_data.suspicious_code or results.hidden_data.zip_hidden) %}نعم{% else %}لا{% endif %}
                </p>
            </div>

            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 border-purple-500">
                <div class="flex items-center mb-3">
                    <i class="fas fa-shield-alt text-purple-400 text-xl mr-2"></i>
                    <h3 class="font-semibold text-white">نتيجة الثقة</h3>
                </div>
                <p class="text-3xl font-bold text-purple-400">{{ (analysis.threat_score * 100) | round if analysis.threat_score else 0 }}%</p>
            </div>
        </div>
    </div>

    <!-- معلومات التصحيح -->
    {% if results and results.analysis_error %}
    <div class="bg-red-900/30 rounded-xl shadow-lg p-6 mb-8 card-hover border border-red-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-red-600">
            <i class="fas fa-exclamation-circle mr-2"></i> خطأ في التحليل
        </h2>
        <p class="text-red-200">{{ results.analysis_error }}</p>
    </div>
    {% endif %}

    {% if results and results.skipped_analysis %}
    <div class="bg-yellow-900/30 rounded-xl shadow-lg p-6 mb-8 card-hover border border-yellow-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-yellow-600">
            <i class="fas fa-exclamation-triangle mr-2"></i> تحذير
        </h2>
        <p class="text-yellow-200">{{ results.reason if results.reason else 'لم يتم إجراء تحليل متقدم لهذا النوع من الملفات.' }}</p>
    </div>
    {% endif %}

    <!-- معلومات نوع الملف -->
    {% if results and results.file_info %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">معلومات نوع الملف</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-gray-400">نوع MIME:</p>
                <p class="font-medium text-white">{{ results.file_info.mime_type|default('غير معروف') }}</p>
            </div>
            <div>
                <p class="text-gray-400">الامتداد:</p>
                <p class="font-medium text-white">{{ results.file_info.extension|default('غير معروف') }}</p>
            </div>
            <div>
                <p class="text-gray-400">طريقة الكشف:</p>
                <p class="font-medium text-white">{{ results.file_info.type_method|default('غير معروف') }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قسم التحليل السلوكي -->
    {% if results and results.behavioral_analysis %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">التحليل السلوكي</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <p class="text-gray-400">الإنتروبيا:</p>
                <p class="font-medium text-white">{{ results.behavioral_analysis.entropy|round(2) if results.behavioral_analysis.entropy else 'غير معروف' }}</p>
            </div>
            <div>
                <p class="text-gray-400">مؤشرات إخفاء المعلومات:</p>
                <p class="font-medium {% if results.behavioral_analysis.steganography_indications %}text-red-400{% else %}text-green-400{% endif %}">
                    {% if results.behavioral_analysis.steganography_indications %}نعم{% else %}لا{% endif %}
                </p>
            </div>
            <div>
                <p class="text-gray-400">الأنماط المشبوهة:</p>
                <p class="font-medium text-white">
                    {% if results.behavioral_analysis.suspicious_patterns %}
                        {{ results.behavioral_analysis.suspicious_patterns|join(', ') }}
                    {% else %}
                        لا توجد
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قسم تحليل التصيد المتقدم -->
    {% if results and results.advanced_phishing_analysis %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">تحليل التصيد المتقدم</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-gray-400">درجة التصيد:</p>
                <p class="font-medium text-white">{{ (results.advanced_phishing_analysis.phishing_score * 100)|round(2) if results.advanced_phishing_analysis.phishing_score else 0 }}%</p>
            </div>
            <div>
                <p class="text-gray-400">الحالة:</p>
                <p class="font-medium {% if results.advanced_phishing_analysis.is_phishing %}text-red-400{% else %}text-green-400{% endif %}">
                    {% if results.advanced_phishing_analysis.is_phishing %}تصيد محتمل{% else %}آمن{% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- قسم Threat Intelligence -->
    {% if results and results.threat_intelligence %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">Threat Intelligence</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% if results.threat_intelligence.virustotal %}
            <div>
                <p class="text-gray-400">VirusTotal:</p>
                <p class="font-medium {% if results.threat_intelligence.virustotal.get('positives', 0) > 0 %}text-red-400{% else %}text-green-400{% endif %}">
                    {{ results.threat_intelligence.virustotal.get('positives', 0) }}/{{ results.threat_intelligence.virustotal.get('total', 0) }}
                </p>
            </div>
            {% endif %}
            {% if results.threat_intelligence.alienvault %}
            <div>
                <p class="text-gray-400">AlienVault:</p>
                <p class="font-medium {% if results.threat_intelligence.alienvault.get('pulse_count', 0) > 0 %}text-red-400{% else %}text-green-400{% endif %}">
                    {{ results.threat_intelligence.alienvault.get('pulse_count', 0) }} تهديدات مرتبطة
                </p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- النص المستخرج -->
    {% if results and results.extracted_text %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">النص المستخرج</h2>

        <div class="bg-gray-900/60 rounded-lg p-4 max-h-60 overflow-y-auto">
            <p class="text-sm text-gray-300 whitespace-pre-wrap">{{ results.extracted_text }}</p>
        </div>
    </div>
    {% endif %}

    <!-- تحليل النص -->
    {% if results and results.text_analysis and results.text_analysis.threats %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">التهديدات النصية المكتشفة</h2>

        <div class="space-y-3">
            {% for threat in results.text_analysis.threats %}
            <div class="bg-gray-900/60 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-sm font-medium text-red-400">{{ threat.category }}:</span>
                        <span class="text-sm text-gray-300">{{ threat.pattern }}</span>
                    </div>
                    <span class="px-2 py-1 bg-red-500/30 text-red-300 text-xs rounded-full">
                        {{ threat.count }} مرات
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- النص المخفي -->
    {% if results and results.hidden_text and results.hidden_text != "Error in hidden text detection: " %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">النص المخفي المكتشف</h2>

        <div class="bg-gray-900/60 rounded-lg p-4 max-h-60 overflow-y-auto">
            <p class="text-sm text-gray-300 whitespace-pre-wrap">{{ results.hidden_text }}</p>
        </div>
    </div>
    {% endif %}

    <!-- نتائج تعلم الآلة -->
    {% if results and results.ml_analysis %}
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">تحليل نموذج تعلم الآلة</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <p class="text-gray-400">درجة الثقة:</p>
                <p class="font-medium text-white">{{ (results.ml_analysis.malware_score * 100) | round(2) if results.ml_analysis.malware_score else 0 }}%</p>
            </div>
            <div>
                <p class="text-gray-400">الحالة:</p>
                <p class="font-medium {% if results.ml_analysis.is_malicious %}text-red-400{% else %}text-green-400{% endif %}">
                    {% if results.ml_analysis.is_malicious %}ضار{% else %}آمن{% endif %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- خيارات التقرير -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 border-t-4 border-red-500 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-cog mr-2"></i> خيارات التقرير
        </h2>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <!-- زر فحص صورة أخرى -->
            <a href="{{ url_for('analyze_image') }}"
               class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-medium rounded-lg hover:from-blue-700 hover:to-indigo-800 transition-all flex items-center justify-center">
                <i class="fas fa-redo mr-2"></i> فحص جديد
            </a>

            <!-- زر العودة للوحة التحكم -->
            <a href="{{ url_for('dashboard') }}"
               class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-indigo-800 text-white font-medium rounded-lg hover:from-indigo-700 hover:to-indigo-900 transition-all flex items-center justify-center">
                <i class="fas fa-tachometer-alt mr-2"></i> لوحة التحكم
            </a>

            <!-- زر مشاركة التقرير -->
            <button onclick="shareReport()"
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-700 text-white font-medium rounded-lg hover:from-purple-700 hover:to-indigo-800 transition-all flex items-center justify-center">
                <i class="fas fa-share-alt mr-2"></i> مشاركة
            </button>

            <!-- زر حذف التقرير -->
            {% if current_user.is_admin %}
            <button onclick="confirmDelete('image', '{{ analysis.id }}')"
                    class="px-6 py-3 bg-gradient-to-r from-red-600 to-red-800 text-white font-medium rounded-lg hover:from-red-700 hover:to-red-900 transition-all flex items-center justify-center">
                <i class="fas fa-trash-alt mr-2"></i> حذف التقرير
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- نافذة تأكيد الحذف -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-gray-800 rounded-2xl p-6 w-96">
        <h3 class="text-xl font-bold text-white mb-4">تأكيد الحذف</h3>
        <p class="text-gray-300 mb-6">هل أنت متأكد من أنك تريد حذف هذا التقرير؟ هذا الإجراء لا يمكن التراجع عنه.</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                إلغاء
            </button>
            <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                تأكيد الحذف
            </button>
        </div>
    </div>
</div>

<script>
// نافذة تأكيد الحذف
let currentAnalysisId = null;
let currentAnalysisType = null;

function confirmDelete(type, analysisId) {
    currentAnalysisType = type;
    currentAnalysisId = analysisId;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    currentAnalysisId = null;
    currentAnalysisType = null;
}

// تأكيد الحذف
document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (currentAnalysisId && currentAnalysisType) {
        fetch(`/delete_${currentAnalysisType}_report/${currentAnalysisId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('تم حذف التقرير بنجاح');
                window.location.href = "{{ url_for('dashboard') }}";
            } else {
                alert('فشل في حذف التقرير: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء محاولة الحذف');
        })
        .finally(() => {
            closeDeleteModal();
        });
    }
});

// إغلاق النافذة عند النقر خارجها
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target.id === 'deleteModal') {
        closeDeleteModal();
    }
});

// مشاركة التقرير
function shareReport() {
    const reportUrl = window.location.href;

    navigator.clipboard.writeText(reportUrl).then(() => {
        alert('تم نسخ رابط التقرير إلى الحافظة: ' + reportUrl);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('تعذر نسخ الرابط. يرجى المحاولة مرة أخرى.');
    });
}

// إغلاق النافذة بالزر Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});
</script>
{% endblock %}